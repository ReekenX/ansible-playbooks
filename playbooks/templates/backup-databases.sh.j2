#!/bin/bash
# Database backup script - generated by Ansible
# Backs up databases to /var/backups with best compression

set -euo pipefail

DATE=$(date +%Y-%m-%d)
BACKUP_DIR="/var/backups"
RETENTION_DAYS={{ backup_retention_days | default(30) }}

{% for db in backup_databases | default([]) %}
echo "Backing up {{ db.name }}..."
{{ db.cmd }} | gzip -9 > "$BACKUP_DIR/{{ db.name }}-$DATE.sql.gz"
{% endfor %}

echo "Removing backups older than $RETENTION_DAYS days..."
{% for db in backup_databases | default([]) %}
find "$BACKUP_DIR" -name "{{ db.name }}-*.sql.gz" -mtime +$RETENTION_DAYS -delete
{% endfor %}

echo "All backups completed."
