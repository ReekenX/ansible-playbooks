---
- hosts: all
  become: yes

  tasks:
  - name: Check available disk space
    shell: df / --output=pcent | tail -1 | tr -d ' %'
    register: disk_usage
    changed_when: false
    failed_when: disk_usage.stdout | int > 90

  - name: Update APT package cache
    apt:
      update_cache: yes
      cache_valid_time: 3600

  - name: Perform dist upgrade
    apt:
      upgrade: dist
      update_cache: yes
      autoclean: yes
    register: upgrade_result

  - name: Autoremove unused packages
    apt:
      autoremove: yes
      purge: yes
    register: autoremove_result

  - name: Find residual kernel packages
    shell: |
      set -o pipefail
      dpkg -l | grep "^rc\s*linux-image-" | awk '{print $2}' || true
    args:
      executable: /bin/bash
    register: residual_kernels
    changed_when: false

  - name: Purge residual kernel packages
    apt:
      name: "{{ residual_kernels.stdout_lines }}"
      state: absent
      purge: yes
    when: residual_kernels.stdout_lines | length > 0
    register: kernel_purge_result

  - name: Check if reboot is required
    stat:
      path: /var/run/reboot-required
    register: reboot_required

  - name: Build upgrade summary
    set_fact:
      upgrade_summary:
        packages_upgraded: "{{ upgrade_result.changed }}"
        autoremove_executed: "{{ autoremove_result.changed }}"
        kernels_purged: "{{ kernel_purge_result.changed | default(false) }}"
        reboot_required: "{{ reboot_required.stat.exists }}"

  - name: Display upgrade summary
    debug:
      var: upgrade_summary
